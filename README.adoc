image::https://static.jboss.org/hibernate/images/hibernate_logo_whitebkg_200px.png[]

# Hibernate 6.1 and NuoDB &nbsp; &nbsp; image:https://d33wubrfki0l68.cloudfront.net/571989f106f60bced5326825bd63918a55bdf0aa/dd52a/_/img/nuodb-bird-only-green.png"[height=50]

This is a fork of Hibernate ORM (http://github.com/hibernate/hibernate-orm) branch 6.1 to allow testing of NuoDB's Hibernate 6 dialect.
The tests of interest are the matrix tests (which allow testing against multiple databases).
Unfortunately the section on Matrix testing (in the original README below) is yet to be written (for at least 4 years).

## Running Tests

To run the matrix tests for NuoDB:

1. You must have Java JDK 8 installed.  Java 11 won't work.
   * _Recommendation:_ Install `jenv` from https://github.com/jenv/jenv to manage your JVMs.
      * You may need to tell it which JDKs you have.
   * There is a `.java-version` file in this project, telling `jenv` to use Java 1.8.
   * If necessary, to switch to Java 8, run `jenv local 1.8`.

1. Next, make sure you have our Hibernate 5 dialect jar available:

   * clone https://github.com/nuodb/HibernateDialect5
   * Run `mvn install` - see [project README](https://github.com/nuodb/HibernateDialect5/blob/master/README.md)
   * Check the version in the POM - it will be of the form `nuodb-hibernate.NN.x.x-hib5`
      * You will need to set `DIALECT_VERSION` to `NN.x.x` to match - see below.

1. This project's gradle build file assumes you have your maven repository in
   the default location (`.m2` in your home directory). If so, skip this step.

   Otherwise you must tell gradle where this dependency can be found. For example
   suppose you use `m2` instead of `.m2`:

   ```sh
   export ADDITIONAL_REPO=~/m2/repository/com/nuodb/hibernate/nuodb-hibernate/NN.x.x-hib5               (Linux/MacOS)

   set ADDITIONAL_REPO=c:\Users\yourname\m2\repository\com\nuodb\hibernate\nuodb-hibernate\NN.x.x-hib5  (Windows)
   ```

1. Set the Hibernate dialect - this must match the Hibernate 5 dialect you installed earlier.

   * **Note:** the value you set _does not_ have `-hib5` in the end:

     ```bash
     export DIALECT_VERSION=NN.x.x      (Linux/MacOS)
     set DIALECT_VERSION=NN.x.x         (Windows)
     ```

   * Alternatively, non-Windows users may prepend it to any command: `DIALECT_VERSION=NN.x.x ./gradlew ...`

1. You need a database called `hibernate_orm_test` running locally on your machine with username and password also `hibernate_orm_test`.
Here are two options using Docker:

   * To use docker compose, clone http://github.com/nuodb/nuodb-compose and (per the README):
       * `cd nuodb` and `cp env_default` to `.env`.
       * Edit `.env` and set `DB_NAME`, `DB_USER` and `DB_PASSWORD` to `hibernate_orm_test`.
         Also (last line) set `EXTERNAL_ADDRESS=127.0.0.1`.
       * Run: `docker compose -p hib -f monolith.yaml up -d`
       * Run: `docker exec -it hib-monolith-1 nuocmd show domain`

   * Or, setup a local database by running `setup.sh` inside `env` folder.
     This script will create a NuoDB env with an admin service, a Storage Manager (SM) and a Transaction Engine (TE) to run the tests against. Requires docker to be installed on the server.

1. You need `gradle` installed.
   To setup gradle, see original `README` content below.  The expected output is:

1. To run the matrix test-suite using NuoDB as the database, execute:

   * Windows (using `gradlew.bat`):

      ```sh
      #set TEST_PLAN=green
      set DIALECT_VERSION=22.0.1-hib5
      gradlew clean hibernate-core:matrix_nuodb
      ```

   * MacOS/Linux

      ```sh
      #TEST_PLAN=green ./gradlew clean hibernate-core:matrix_nuodb
      DIALECT_VERSION=22.0.1-hib5 ./gradlew clean hibernate-core:matrix_nuodb
      ```

   * Expected output is something like:

     ```sh
     10583 tests completed, 73 failed, 1984 skipped
     ```

   * **Warnings:**
     * If you run the tests without the `clean` option you may get a weird internal error in the compiler.

     * Not all tests clean up after themselves.
       If using the local database you may need to restart the environment by rerunning the script `env/setup.sh`.

     * Test execution takes ~30m in average with a live database and ~3m without.
        * The tests will keep running, and failing even if the database is not available.
        * If the tests run quickly, that's the hint that your database isn't running!

1. Run individual tests (does this actually work?).

   Example commands:

   ```sh
   ./gradlew clean :hibernate-core:matrix_nuodb --tests org.hibernate.jpa.test.packaging.PackagedEntityManagerTest
   ./gradlew clean :hibernate-core:matrix_nuodb --tests *.PackagedEntityManagerTest
   ./gradlew clean :hibernate-core:matrix_nuodb --tests org.hibernate.jpa.test.packaging.*
   ```

   **NOTE:** Not all tests are against NuoDB and actually some are explicitly skipped due to timeout and locks. Those tests have the special annotation `@SkipForDialect(value = NuoDBDialect.class)`

1. Pull Jar from Sonatype

   Once our jar is put up at Sonatype, its URL is something like https://oss.sonatype.org/content/repositories/comnuodb-YYYY/com/nuodb/hibernate/nuodb-hibernate/NN.x.x-hib5/nuodb-hibernate-NN.x.x-hib5.jar.
   Note the build number - YYYY (a 4 digit number such as 1050). To use this dependency run as follows:

   ```sh
   SONATYPE_VERSION=YYYY gradle clean ...   (Linux)

   set SONATYPE_VERSION=YYYY               (Windows)
   gradle clean ...
   ```

Please note that even if a NuoDB database is not available, 4588 tests complete, 2823 fail, and 840 are skipped. So many tests pass without using the database because the tests are intended for testing Hibernate not the underlying database.
We are just piggybacking on them for convenience.

## Upgrade Hibernate Dialect

If the Hibernate dialect has a new version number:

1. Update the environment variable: `SET DIALECT_VERSION=NN.x.x`

2. The JAR version is required in three places.

    * `build.gradle`
       * Contains a "smart" class `NuodbHibernateVersion` which either picks up `DIALECT_VERSION` or looks in the local Maven repo to
         find the latest version of the JAR in there.
         If you have just built and installed a new version of the JAR, it should find it.
       * The class sets variable `nuodbHibernateJarVersion` to the version it has found.
    * `databases/nuodb/matrix.gradle` - referenced `${nuodbHibernateJarVersion}`.
    * `hibernate-core/hibernate-core.gradle` - also references `${nuodbHibernateJarVersion}`.

## Upgrade NuoDB JDBC Driver

This must be changed manually in two places:

1. `databases/nuodb/matrix.gradle`: `jdbcDependency "com.nuodb.jdbc:nuodb-jdbc:24.0.0"`
2. `hibernate-core/hibernate-core.gradle`:  `testRuntime( "com.nuodb.jdbc:nuodb-jdbc:24.0.0" )`

## Changes Made to Project

To use NuoDB

1. Added `databases/nuodb` to define dependencies and configuration required to use NuoDB.

1. Added references to the NuoDB dialect and/or NuoDB JDBC jars to:
     * `build.gradle`
     * `databases/nuodb/matrix.gradle`
     * `hibernate-core/hibernate-core.gradle`

To configure NuoDB

1. Set the versions of NuoDB's JDBC and Dialect Jars in  [`databases/nuodb/matrix.gradle`](databases/nuodb/matrix.gradle)
2. To configure the NuoDB data source modify [`databases/nuodb/resources/hibernate.properties`](databases/nuodb/resources/hibernate.properties)
3. Make same modifications to [`hibernate-core/src/test/resources/hibernate.properties`](hibernate-core/src/test/resources/hibernate.properties) - this is the one that actually gets used.

## To Run in IntelliJ

It is possible to run the tests in IntelliJ (Eclipse's gradle support can't handle this project).

Open as a gradle project in IntelliJ in the usual way.

To force it to use NuoDB: `cp databases/nuodb/resources/hibernate.properties hibernate-core/out/test/resources/hibernate.properties`.

---
---

# Original README

Hibernate ORM is a library providing Object/Relational Mapping (ORM) support
to applications, libraries, and frameworks.

It also provides an implementation of the JPA specification, which is the standard Java specification for ORM.

This is the repository of its source code; see https://hibernate.org/orm/[Hibernate.org] for additional information.

image:https://ci.hibernate.org/job/hibernate-orm-pipeline/job/6.1/badge/icon[Build Status,link=https://ci.hibernate.org/job/hibernate-orm-pipeline/job/6.1/]

== Continuous Integration

Hibernate uses both https://jenkins-ci.org[Jenkins] and https://github.com/features/actions[GitHub Actions]
for its CI needs. See

* https://ci.hibernate.org/view/ORM/[Jenkins Jobs]
* https://github.com/hibernate/hibernate-orm/actions[GitHub Actions Jobs]

== Building from sources

The build requires at least Java 11 JDK.

Hibernate uses https://gradle.org[Gradle] as its build tool. See the _Gradle Primer_ section below if you are new to
Gradle.

Contributors should read the link:CONTRIBUTING.md[Contributing Guide].

See the guides for setting up https://hibernate.org/community/contribute/intellij-idea/[IntelliJ] or
https://hibernate.org/community/contribute/eclipse-ide/[Eclipse] as your development environment.

== Gradle Primer

The Gradle build tool has amazing documentation.  2 in particular that are indispensable:

* https://docs.gradle.org/current/userguide/userguide_single.html[Gradle User Guide] is a typical user guide in that
it follows a topical approach to describing all of the capabilities of Gradle.
* https://docs.gradle.org/current/dsl/index.html[Gradle DSL Guide] is unique and excellent in quickly
getting up to speed on certain aspects of Gradle.

We will cover the basics developers and contributors new to Gradle need to know to get productive quickly.

NOTE: The project defines a https://docs.gradle.org/current/userguide/gradle_wrapper.html[Gradle Wrapper].
The rest of the section will assume execution through the wrapper.

=== Executing Tasks

Gradle uses the concept of build tasks (equivalent to Ant targets or Maven phases/goals). You can get a list of
available tasks via 

----
gradle tasks
----

To execute a task across all modules, simply perform that task from the root directory. Gradle will visit each
sub-project and execute that task if the sub-project defines it. To execute a task in a specific module you can
either:

. `cd` into that module directory and execute the task
. name the "task path". For example, to run the tests for the _hibernate-core_ module from the root directory
you could say `gradle hibernate-core:test`

=== Common tasks

The common tasks you might use in building Hibernate include:

* _build_ - Assembles (jars) and tests this project
* _compile_ - Performs all compilation tasks including staging resources from both main and test
* _jar_ - Generates a jar archive with all the compiled classes
* _test_ - Runs the tests
* _publishToMavenLocal_ - Installs the project jar to your local maven cache (aka ~/.m2/repository). Note that Gradle
never uses this, but it can be useful for testing your build with other local Maven-based builds.
* _clean_ - Cleans the build directory

== Testing and databases

Testing against a specific database can be achieved in 2 different ways:

=== Using the "Matrix Testing Plugin" for Gradle.

Coming later…

=== Using "profiles"

The Hibernate build defines several database testing "profiles" in `databases.gradle`. These
profiles can be activated by name using the `db` build property which can be passed either as
a JVM system prop (`-D`) or as a Gradle project property (`-P`). Examples below use the Gradle
project property approach.

----
gradle clean build -Pdb=pgsql
----

To run a test from your IDE, you need to ensure the property expansions happen.
Use the following command:

----
gradle clean compile -Pdb=pgsql
----

__NOTE: If you are running tests against a JDBC driver that is not available via Maven central be sure to
add these drivers to your local Maven repo cache (~/.m2/repository) or (better) add it to a personal Maven repo server__

=== Running database-specific tests from the IDE using "profiles"

You can run any test on any particular database that is configured in a `databases.gradle` profile.

All you have to do is run the following command:

----
./gradlew setDataBase -Pdb=pgsql
----

or you can use the shortcut version: 

----
./gradlew sDB -Pdb=pgsql
----

You can do this from the module which you are interested in testing or from the `hibernate-orm` root folder.

Afterward, just pick any test from the IDE and run it as usual. Hibernate will pick the database configuration from the `hibernate.properties`
file that was set up by the `setDataBase` Gradle task.

=== Starting test databases locally as docker containers

You don't have to install all databases locally to be able to test against them in case you have docker available.
The script `docker_db.sh` allows you to start a pre-configured database which can be used for testing.

All you have to do is run the following command:

----
./docker_db.sh postgresql
----

omitting the argument will print a list of possible options.

When the database is properly started, you can run tests with special profiles that are suffixed with `_ci`
e.g. `pgsql_ci` for PostgreSQL. By using the system property `dbHost` you can configure the IP address of your docker host.

The command for running tests could look like the following:

----
./gradlew test -Pdb=pgsql_ci "-DdbHost=192.168.99.100"
----

The following table illustrates a list of commands for various databases that can be tested locally.

|===
|Database |`docker_db.sh` |Gradle command

|H2
|-
|`./gradlew test -Pdb=h2`

|HSQLDB
|-
|`./gradlew test -Pdb=hsqldb`

|Apache Derby
|-
|`./gradlew test -Pdb=derby`

|MySQL 5.7
|`./docker_db.sh mysql`
|`./gradlew test -Pdb=mysql_ci`

|MySQL 8.0
|`./docker_db.sh mysql_8_0`
|`./gradlew test -Pdb=mysql_ci`

|MariaDB
|`./docker_db.sh mariadb`
|`./gradlew test -Pdb=mariadb_ci`

|PostgreSQL 9.5
|`./docker_db.sh postgresql`
|`./gradlew test -Pdb=pgsql_ci`

|PostgreSQL 13
|`./docker_db.sh postgresql_13`
|`./gradlew test -Pdb=pgsql_ci`

|EnterpriseDB
|`./docker_db.sh edb`
|`./gradlew test -Pdb=edb_ci`

|Oracle XE
|`./docker_db.sh oracle`
|`./gradlew test -Pdb=oracle_ci`

|Oracle 11g
|`./docker_db.sh oracle_11`
|`./gradlew test -Pdb=oracle_ci`

|Oracle XE 18
|`./docker_db.sh oracle_18`
|`./gradlew test -Pdb=oracle_ci`

|Oracle XE 21
|`./docker_db.sh oracle_21`
|`./gradlew test -Pdb=oracle_ci`

|Oracle EE
|`./docker_db.sh oracle_ee`
|`./gradlew test -Pdb=oracle_docker`

|DB2
|`./docker_db.sh db2`
|`./gradlew test -Pdb=db2_ci`

|SQL Server
|`./docker_db.sh mssql`
|`./gradlew test -Pdb=mssql_ci`

|Sybase ASE
|`./docker_db.sh sybase`
|`./gradlew test -Pdb=sybase_ci`

|SAP HANA
|`./docker_db.sh hana`
|`./gradlew test -Pdb=hana_ci`

|CockroachDB
|`./docker_db.sh cockroachdb`
|`./gradlew test -Pdb=cockroachdb`
|===
