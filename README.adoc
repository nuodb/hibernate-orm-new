image::https://static.jboss.org/hibernate/images/hibernate_logo_whitebkg_200px.png[]

# Hibernate 6.1 and NuoDB &nbsp; &nbsp; image:https://d33wubrfki0l68.cloudfront.net/571989f106f60bced5326825bd63918a55bdf0aa/dd52a/_/img/nuodb-bird-only-green.png[height=50]

This is a fork of Hibernate ORM (http://github.com/hibernate/hibernate-orm) branch 6.1 to allow testing of NuoDB's Hibernate 6 dialect.
The tests of interest are the matrix tests (which allow testing against multiple databases).
Unfortunately the section on Matrix testing (in the original README below) is yet to be written (for at least 4 years).

## Running Tests

To run the matrix tests for NuoDB:

. You must have Java JDK 11 installed.  Java 8 isn't supported by Hibernate 6.x.

* _Recommendation:_ Install `jenv` from https://github.com/jenv/jenv to manage your JVMs.
   * You may need to tell it which JDKs you have.
** There is a `.java-version` file in this project, telling `jenv` to use Java 11.
** If necessary, use `jenv` to switch to Java 11.
For example, to use 11.0.18, run `jenv local 11.0.18`.
* Alternatively use `sdkman`: https://sdkman.io

. Next, make sure you have our Hibernate 6 dialect jar available:

* Clone https://github.com/nuodb/HibernateDialect6
* Run `mvn -Dgpg.skip install` - see https://github.com/nuodb/HibernateDialect6#readme[project README].
* Check the version in the POM - it will be of the form `nuodb-hibernate.NN.x.x-hib6`
   * You will need to set `DIALECT_VERSION` to `NN.x.x-hib6` to match - see below.

. This project's gradle build file assumes you have your maven repository in
   the default location (`.m2` in your home directory). If so, skip this step.

* Otherwise you must tell gradle where this dependency can be found. For example
suppose you use `m2` instead of `.m2`:
+
```sh
export ADDITIONAL_REPO=~/m2/repository/com/nuodb/hibernate/nuodb-hibernate/NN.x.x-hib6               (Linux/MacOS)

set ADDITIONAL_REPO=c:\Users\yourname\m2\repository\com\nuodb\hibernate\nuodb-hibernate\NN.x.x-hib6  (Windows)
```

. Set the Hibernate dialect - this must match the Hibernate 6 dialect you installed earlier.

* **Note:** the value you set _should_ have `-hib6` in the end, but that's optional:
+
```bash
export DIALECT_VERSION=NN.x.x-hib6      (Linux/MacOS)
set DIALECT_VERSION=NN.x.x-hib6         (Windows)
```

* Alternatively, MacOS and Linux users may prepend it to any command:
** `DIALECT_VERSION=NN.x.x-hib6 ./gradlew ...`

. You need a database called `hibernate_orm_test` running locally on your machine with username and password also `hibernate_orm_test`.
If you do not have NuoDB installed locally, here are some options using Docker:

* Optionally, on MacOS, download the lighter weight OrbStack instead of Docker Desktop.
** Once OrbStack is running, the `docker` command works as normal.

* To use `docker compose`:
** clone http://github.com/nuodb/nuodb-compose and (per the README):
** `cd nuodb` and `cp env_default` to `.env`.
** Edit `.env` and set `DB_NAME`, `DB_USER` and `DB_PASSWORD` to `hibernate_orm_test`.
Also (last line) set `EXTERNAL_ADDRESS=127.0.0.1`.
** Run: `docker compose -p hib -f monolith.yaml up -d`
** Run: `docker exec -it hib-monolith-1 nuocmd show domain`

* Or, setup a local database by running `setup.sh` inside `env` folder.
   This script will create a NuoDB env with an admin service, a Storage Manager (SM) and a Transaction Engine (TE) to run the tests against.

. For information on `gradle` refer to the original `README` content <<gradle-primer,below>>.

. To run the matrix test-suite using NuoDB as the database, execute the following:

* Windows (using `gradlew.bat`):
+
```sh
set DIALECT_VERSION=23.0.2-hib6
gradlew --rerun-tasks clean hibernate-core:matrix_nuodb
```

* MacOS/Linux
+
```sh
DIALECT_VERSION=23.0.2-hib6 ./gradlew --rerun-tasks clean hibernate-core:matrix_nuodb
```

* Expected final output is something like:
+
```sh
6186 tests completed, 0 failed, 1592 skipped
```

* Full details of all failing and ignored tests can be found at `hibernate-core/target/matrix/nuodb/reports/index.html`.
** This directory is not fully populated until the test-run has finished and will be deleted by the next test run (take a copy if necessary).

. To run individual tests, put the fully-qualified name of the JUnit test class(es) in `hibernate-core/green-list.txt`.
* If this class contains _any_ test names, _only_ the tests in this file will be run.
* This is _not_ equivalent to the old green `TEST_PLAN`, it is intended only to allow one or more individual tests to be run, typically for debugging failing tests.
* To run all the tests again, simply delete or comment out the tests in hibernate-core/green-list.txt (to comment, put a `#` at the start of each line).


. **Notes and Warnings:**

   * The run will fail with an error (and run no tests) if the required database cannot be connected to.

   * These tests are intended for testing Hibernate as well as the underlying database.
      Many tests will be skipped if they use features our dialect does not support, and that is normal.
      We are just piggybacking on these tests for convenience.

   * Any test whose fully qualified class name is listed in `hibernate-core/skip-tests.txt` will be ignored.
     The tests listed fail due to known limitations in NuoDB SQL (see comments in the file).

   * If you run the tests without the `clean` option you may get a weird internal error in the compiler.

   * Not all tests clean up after themselves.
     If using the local database you may need to reset the environment
   ** Either by using `docker compose` to destroy the container and then recreate it.
   ** Or by rerunning the script `env/setup.sh`.

   * Test execution takes ~15-20 mins on average with a live database.

   * When running the matrix tests `hibernate-core/target/matrix/nuodb` is the working directory.

   * Not all tests are against NuoDB and actually some are explicitly skipped due to timeout, locking anomolies, or because they generate SQL syntax NuoDB does not yet support.
   Those tests have the special annotation `@SkipForDialect(value = NuoDBDialect.class)`.


. Run individual tests:

.. Using Gradle (does this actually work?).
+
Example commands:
+
```sh
./gradlew --rerun-tasks clean :hibernate-core:matrix_nuodb --tests org.hibernate.jpa.test.packaging.PackagedEntityManagerTest
./gradlew --rerun-tasks clean :hibernate-core:matrix_nuodb --tests *.PackagedEntityManagerTest
./gradlew --rerun-tasks clean :hibernate-core:matrix_nuodb --tests org.hibernate.jpa.test.packaging.*
```
..  Better to use an IDE - see <<using-an-ide,below>>.

.. Put the fully qualified class name(s) into a new file called `green-list.txt` in `hibernate-core` directory.  The framework will only run the tests in the classes listed.
* Copy `green-list.sample.text` to get started.
* Delete this file when you are done or it will only ever run these tests.

.. Individual tests, and any related files such as entity class definitions, can be copied directly into the `HibernateDialect6` project.
* There are some there already you can use as examples of what to do.

[#using-an-ide]
[start=11]
. Running Tests in an IDE
+
It is possible to run the tests in IntelliJ (but not currently Eclipse - it won't run the Hibernate metadata compiler which generates `_XXX` metadata classes for use with JPA criteria queries).
+
Open `hibernate-core` as a _maven_ project in IntelliJ in the usual way - a `pom.xml` has been added.
+
An IDE is most useful for running individual tests that have failed and debugging them.
+
When running tests with from the IDE, `hibernate-core` is the working directory and the tests automatically detect this and use `src/test/sources/hibernate-nuodb.properties` to configure Hibernate.

* Make sure this matches `databases/nuodb/resources/hibernate.properties`.
* Do _not_ modify `hibernate-core/src/test/resources/hibernate.properties` which is used by the matrix tests.


## Testing JAR from Sonatype

[start=12]
. Pull Jar from Sonatype

* Once our jar is put up at Sonatype, its URL is something like https://oss.sonatype.org/content/repositories/comnuodb-YYYY/com/nuodb/hibernate/nuodb-hibernate/NN.x.x-hib6/nuodb-hibernate-NN.x.x-hib6.jar.
** Note the build number - YYYY (a 4 digit number such as 1050). To use this dependency run as follows:
+
```sh
SONATYPE_VERSION=YYYY gradle clean ...   (Linux)

set SONATYPE_VERSION=YYYY               (Windows)
gradle clean ...
```

## Configure the Database

Modify properties in `databases/nuodb/resources/hibernate.properties`.

* If using an IDE, modify `hibernate-core/src/test/resources/hibernate-nuodb.properties` to match;

* _DO NOT_ change the database name or credentials as they are used by our build system.

## Upgrade Hibernate Dialect

If the Hibernate dialect has a new version number:

* Simply update the environment variable: `SET DIALECT_VERSION=NN.x.x`

The JAR version is required in several places and will pick up the version from the environment variable (therefore no other changes are necessary).

For the record, our Hibernate jar is referred to in:

    * `build.gradle`
    ** Validates `DIALECT_VERSION` is set and adds `-hib6` on the end if necessary.
    ** Sets global variable `ext.nuodbHibernateJarVersion` to the version it has found.

    * `nuodb/databases/matrix.gradle`
    ** Contains a "smart" class `NuodbHibernateVersion` which uses `DIALECT_VERSION` and checks the JAR exists.
       If you have just built and installed a new version of the JAR, it should find it - provided `DIALECT_VERSION` is set accordingly.

    * `databases/nuodb/matrix.gradle`
    ** References `${nuodbHibernateJarVersion}`.

    * `hibernate-core/hibernate-core.gradle`
    ** Also references `${nuodbHibernateJarVersion}`.

## Upgrade NuoDB JDBC Driver

This must be changed manually in several places.
For example to set the version to `24.1.1`:

. `databases/nuodb/matrix.gradle`: `classpath 'com.nuodb.jdbc:nuodb-jdbc:24.1.1'`
. `databases/nuodb/matrix.gradle`: `jdbcDependency "com.nuodb.jdbc:nuodb-jdbc:24.1.1"`
. `hibernate-core/hibernate-core.gradle`: `testImplementation    'com.nuodb.jdbc:nuodb-jdbc:24.1.1'`
. `hibernate-core/pom.xml`: `<nuodb-jar.version>24.1.1</nuodb-jar.version>`
. `settings.gradle`: `alias( "nuodb" ).to( "com.nuodb.jdbc", "nuodb-jdbc" ).version( "24.1.1" )`

To check the current version, run:

```sh
    grep -R nuodb-jdbc * | grep -v target | grep -v caches
```

## Changes Made to Project

To use NuoDB

. Updated this `README.adoc`.

. Added `databases/nuodb` to define dependencies and configuration required to use NuoDB.
  * Added `jdbcDependency "com.nuodb.jdbc:nuodb-jdbc:<version>"` (normally the only thing in this file).
  * Extensive modifications to `databases/nuodb/matrix.gradle` to check that our JARs are on the class path and the database is available for testing.

. Modified `gradle/java-module.gradle` to add `testRuntimeOnly dbLibs.nuodb` with all the other databases listed.

. Modified .gitignore to ignore .factorypath (another Eclipse file).

. Modified build.gradle:
  * To look in the local maven repository (`.m2` in your home directory) for our dialect.
  * To check that environment variable `DIALECT_VERSION` is correctly set, add -hib6 to the end if necessary and save it to `ext.nuodbHibernateJarVersion` for use in other Gradle scripts.

. Modified `hibernate-core/hibernate-core.gradle`:
  * To output the NuoDB dialect it is expecting to use.
  * To also look in the local maven repository for our dialect.
  * To add the NuoDB dialect and NuoDB JDBC jars to dependencies section:

. Added some classes to `hibernate-core/src/test/java/org/hibernate/testing/junit4` to override the defaults in `hibernate-testing`.
  * Modified `BaseUnitTestCase` (the base class for most JUnit tests) and `CustomRunner` (a subclass of `BaseUnitTestCase`) to support ignoring classes listed in `hibernate-core/skip-tests.txt`.
  Avoids having to add `SkipForDialect` to about 200 test classes.

. Added a `pom.xml` to `hibernate-core`.
  * The gradle project is too complex to be loaded by an IDE (tried Eclipse and IntelliJ).
  Besides we are only using tests in `hibernate-core`.
  * Instead, `hibernate-core` can be loaded as a stand-alone project into IntelliJ
  ** Eclipse currently fails due to the use of the JPA meta-data generation plugin - which generates the `XXX_` meta-data classes for each entity `XXX`.

. Test framework modifications:
+
The test framework used by `hibernate-core` can be found in `hibernate-test`. The `hibernate-test` JAR is included in the POM but the matrix tests compiles and uses the classes in  `hibernate-test` directly.
So changes have been made completely internally to `hibernate-core` _only_.
+
Changes are:
+
.. Support the skipping of tests listed in `hibernate-core/skip-tests.txt`.
Tests known to fail due to NuoDB SQL limitations are listed in this file rather than adding `@SkipForDialect`.
When a SQL limitation is removed, the affected tests can be removed from the file.
.. Also added support for `hibernate-core/green-list.txt` to only run specific test(s) for debugging.
.. Suppress misleading stacktraces during test setup and cleanup such as:
* Dropping tables that don't exist
* Failing to create tables that already exist (truncating them instead)
* Dropping PK constraints on tables that no longer exist.
.. Handle exceptions due to known NuoDB SQL limitations, adding them to `extra-tests.txt` so they can be copied into `skip-tests.txt` and ignored in future.

. Specific changes:
+
* Modified/added the following files:
** `hibernate-core/src/main/java/org/hibernate/internal/ExceptionConverterImpl.java`
*** Allow QuietExceptions (see below) to pass through and add SQL to exceptions when available.
** `hibernate-core/src/main/java/org/hibernate/tool/schema/internal/exec/GenerationTargetToDatabase.java`
*** This class sends SQL to the database. Modified to use NuoDBSqlRunner (see below).
** `hibernate-core/src/main/java/org/hibernate/tool/schema/internal/exec/NuoDBSqlRunner.java`
*** Runs SQL for `GenerationTargetToDatabase` but attempts to work around and/or suppress irrelevant exceptions.
`
* Overrode the following files by putting copies in `src/test`:
** `hibernate-core/src/test/java/org/hibernate/internal/SessionFactoryImpl.java`
*** Optionally print the Hibernate configuration properties used to initialize the SessionFactory
** `hibernate-core/src/test/java/org/hibernate/testing/junit4/BaseUnitTestCase.java`
*** Reduce `DEFAULT_GLOBAL_TIMEOUT_MINS` to 5 mins from 30.
** `hibernate-core/src/test/java/org/hibernate/testing/junit4/CustomRunner.java`
*** Add support for skipping tests listed in `skip-tests.txt`.
** `hibernate-core/src/test/java/org/hibernate/tool/schema/internal/SchemaDropperImpl.java`
*** Suppress unnecessary (and potentially misleading) stack traces when schemas are dropped during tests.
** `hibernate-core/src/test/java/org/hibernate/testing/transaction/TransactionUtil.java`
*** Added timeout for NuoDB
** `hibernate-core/src/test/java/org/hibernate/testing/cleaner/DatabaseCleanerContext.java`
*** Add `NuoDBDatabaseCleaner` to list of cleaners.
** `hibernate-core/src/test/java/org/hibernate/testing/cleaner/JdbcConnectionContext.java`
*** Switch to using hibernate-core/src/test/resources/hibernate-nuodb.properties when _not_ running matrix tests.

* Added new files:
** `hibernate-core/src/test/java/org/hibernate/testing/cleaner/NuoDBDatabaseCleaner.java`
*** Removes all schemas, in preparation for a new test.
** `hibernate-core/src/test/java/org/hibernate/testing/support/TestUtils.java`
*** Assorted utilities such as exception logging, determining which test class caused an exception by hunting up the exception stack trace and, most useful, detecting ignorable exceptions (such as known SQL limitations) and throwing `QuietExceptions` instead (which suppress any stack trace, just generating the exception method).
** `hibernate-core/src/test/java/org/hibernate/testing/support/SkipTests.java`
*** Implements skip-tests and green-list.


   the JUnit `CustomRunner` and several related classes to support the skip-test.txt file.

See https://github.com/nuodb/hibernate-orm-new/commit/308fac3c73f6a53419d22d9dbad582ce47dc369c#diff-2895a46fe357ce8c805dd26452184cfce66241c4fdf5e9f0404106a56ed56ed8[Github Commit].

---
---

# Original README

Hibernate ORM is a library providing Object/Relational Mapping (ORM) support
to applications, libraries, and frameworks.

It also provides an implementation of the JPA specification, which is the standard Java specification for ORM.

This is the repository of its source code; see https://hibernate.org/orm/[Hibernate.org] for additional information.

image:https://ci.hibernate.org/job/hibernate-orm-pipeline/job/6.1/badge/icon[Build Status,link=https://ci.hibernate.org/job/hibernate-orm-pipeline/job/6.1/]

== Continuous Integration

Hibernate uses both https://jenkins-ci.org[Jenkins] and https://github.com/features/actions[GitHub Actions]
for its CI needs. See

* https://ci.hibernate.org/view/ORM/[Jenkins Jobs]
* https://github.com/hibernate/hibernate-orm/actions[GitHub Actions Jobs]

== Building from sources

The build requires at least Java 11 JDK.

Hibernate uses https://gradle.org[Gradle] as its build tool. See the _Gradle Primer_ section below if you are new to
Gradle.

Contributors should read the link:CONTRIBUTING.md[Contributing Guide].

See the guides for setting up https://hibernate.org/community/contribute/intellij-idea/[IntelliJ] or
https://hibernate.org/community/contribute/eclipse-ide/[Eclipse] as your development environment.

[#gradle-primer]
== Gradle Primer

The Gradle build tool has amazing documentation.  2 in particular that are indispensable:

* https://docs.gradle.org/current/userguide/userguide_single.html[Gradle User Guide] is a typical user guide in that
it follows a topical approach to describing all of the capabilities of Gradle.
* https://docs.gradle.org/current/dsl/index.html[Gradle DSL Guide] is unique and excellent in quickly
getting up to speed on certain aspects of Gradle.

We will cover the basics developers and contributors new to Gradle need to know to get productive quickly.

NOTE: The project defines a https://docs.gradle.org/current/userguide/gradle_wrapper.html[Gradle Wrapper].
The rest of the section will assume execution through the wrapper.

=== Executing Tasks

Gradle uses the concept of build tasks (equivalent to Ant targets or Maven phases/goals). You can get a list of
available tasks via 

----
gradle tasks
----

To execute a task across all modules, simply perform that task from the root directory. Gradle will visit each
sub-project and execute that task if the sub-project defines it. To execute a task in a specific module you can
either:

. `cd` into that module directory and execute the task
. name the "task path". For example, to run the tests for the _hibernate-core_ module from the root directory
you could say `gradle hibernate-core:test`

=== Common tasks

The common tasks you might use in building Hibernate include:

* _build_ - Assembles (jars) and tests this project
* _compile_ - Performs all compilation tasks including staging resources from both main and test
* _jar_ - Generates a jar archive with all the compiled classes
* _test_ - Runs the tests
* _publishToMavenLocal_ - Installs the project jar to your local maven cache (aka ~/.m2/repository). Note that Gradle
never uses this, but it can be useful for testing your build with other local Maven-based builds.
* _clean_ - Cleans the build directory

== Testing and databases

Testing against a specific database can be achieved in 2 different ways:

=== Using the "Matrix Testing Plugin" for Gradle.

Coming later…

=== Using "profiles"

The Hibernate build defines several database testing "profiles" in `databases.gradle`. These
profiles can be activated by name using the `db` build property which can be passed either as
a JVM system prop (`-D`) or as a Gradle project property (`-P`). Examples below use the Gradle
project property approach.

----
gradle clean build -Pdb=pgsql
----

To run a test from your IDE, you need to ensure the property expansions happen.
Use the following command:

----
gradle clean compile -Pdb=pgsql
----

__NOTE: If you are running tests against a JDBC driver that is not available via Maven central be sure to
add these drivers to your local Maven repo cache (~/.m2/repository) or (better) add it to a personal Maven repo server__

=== Running database-specific tests from the IDE using "profiles"

You can run any test on any particular database that is configured in a `databases.gradle` profile.

All you have to do is run the following command:

----
./gradlew setDataBase -Pdb=pgsql
----

or you can use the shortcut version: 

----
./gradlew sDB -Pdb=pgsql
----

You can do this from the module which you are interested in testing or from the `hibernate-orm` root folder.

Afterward, just pick any test from the IDE and run it as usual. Hibernate will pick the database configuration from the `hibernate.properties`
file that was set up by the `setDataBase` Gradle task.

=== Starting test databases locally as docker containers

You don't have to install all databases locally to be able to test against them in case you have docker available.
The script `docker_db.sh` allows you to start a pre-configured database which can be used for testing.

All you have to do is run the following command:

----
./docker_db.sh postgresql
----

omitting the argument will print a list of possible options.

When the database is properly started, you can run tests with special profiles that are suffixed with `_ci`
e.g. `pgsql_ci` for PostgreSQL. By using the system property `dbHost` you can configure the IP address of your docker host.

The command for running tests could look like the following:

----
./gradlew test -Pdb=pgsql_ci "-DdbHost=192.168.99.100"
----

The following table illustrates a list of commands for various databases that can be tested locally.

|===
|Database |`docker_db.sh` |Gradle command

|H2
|-
|`./gradlew test -Pdb=h2`

|HSQLDB
|-
|`./gradlew test -Pdb=hsqldb`

|Apache Derby
|-
|`./gradlew test -Pdb=derby`

|MySQL 5.7
|`./docker_db.sh mysql`
|`./gradlew test -Pdb=mysql_ci`

|MySQL 8.0
|`./docker_db.sh mysql_8_0`
|`./gradlew test -Pdb=mysql_ci`

|MariaDB
|`./docker_db.sh mariadb`
|`./gradlew test -Pdb=mariadb_ci`

|PostgreSQL 9.5
|`./docker_db.sh postgresql`
|`./gradlew test -Pdb=pgsql_ci`

|PostgreSQL 13
|`./docker_db.sh postgresql_13`
|`./gradlew test -Pdb=pgsql_ci`

|EnterpriseDB
|`./docker_db.sh edb`
|`./gradlew test -Pdb=edb_ci`

|Oracle XE
|`./docker_db.sh oracle`
|`./gradlew test -Pdb=oracle_ci`

|Oracle 11g
|`./docker_db.sh oracle_11`
|`./gradlew test -Pdb=oracle_ci`

|Oracle XE 18
|`./docker_db.sh oracle_18`
|`./gradlew test -Pdb=oracle_ci`

|Oracle XE 21
|`./docker_db.sh oracle_21`
|`./gradlew test -Pdb=oracle_ci`

|Oracle EE
|`./docker_db.sh oracle_ee`
|`./gradlew test -Pdb=oracle_docker`

|DB2
|`./docker_db.sh db2`
|`./gradlew test -Pdb=db2_ci`

|SQL Server
|`./docker_db.sh mssql`
|`./gradlew test -Pdb=mssql_ci`

|Sybase ASE
|`./docker_db.sh sybase`
|`./gradlew test -Pdb=sybase_ci`

|SAP HANA
|`./docker_db.sh hana`
|`./gradlew test -Pdb=hana_ci`

|CockroachDB
|`./docker_db.sh cockroachdb`
|`./gradlew test -Pdb=cockroachdb`
|===
